# EDS Block Generator MCP Server (Artifact-Driven, ID-Free)

This Model Context Protocol (MCP) server automates generation of Adobe Edge Delivery Services (EDS) blocks from a pre-extracted design context (code snapshot + optional screenshot/metadata). The legacy live Figma API dependency has been fully removed along with all `figmaFileKey` / `figmaNodeId` parameters. You now provide only a `generatedCode` artifact (e.g. React + Tailwind markup) produced upstream (such as by a separate MCP that talks to Figma). The server converts that artifact into a production‑ready EDS block in minutes.

## Features

- **Artifact-Only Workflow**: Consumes provided design code (no runtime Figma API calls or Figma IDs)
- **Automated Block Generation**: Creates complete EDS blocks with all required files
- **Universal Editor Support**: Generates blocks compatible with Universal Editor DOM structure
- **Design System Integration**: Uses EY theme CSS variables exclusively
- **Production Ready**: Generates linting-compliant, accessible, and performant blocks
- **Provenance Hashing (optional)**: When `persistContext` is true, stores a SHA256 hash of `generatedCode` for traceable regeneration

## Tools Provided

### `analyzeBlockStructure`
Analyzes a provided design context code snapshot to infer block structure and content fields. Always generate the code first (e.g. via a design-context extraction tool) and pass it via `generatedCode`. Figma identifiers are not required nor accepted.

**Parameters:**
- `generatedCode` (required): React + Tailwind (or HTML/CSS) snapshot of the design (>10 chars)
- `screenshot` (optional): Base64 or URL screenshot (improves debug provenance only)
- `metadata` (optional): Additional JSON metadata extracted upstream

**Returns:**
- Block type (single or multi-item) 
- Content structure with field definitions
- Design tokens and styling analysis
- Interaction and CTA analysis
- Debug information including MCP integration status

### `generateEdsBlock`
Generates complete EDS block files directly from the provided `generatedCode` (internally performs an analysis step first). Figma file keys and node IDs have been removed; do not include them.

**Parameters:**
- `blockName` (required): Lowercase hyphenated block name
- `outputPath` (required): Directory root (usually `./blocks`)
- `generatedCode` (required): Design code snapshot (>10 chars)
- `screenshot` (optional): Base64 or URL screenshot
- `metadata` (optional): Additional JSON metadata
- `persistContext` (optional): If true, saves artifacts + provenance hash to `.tmp/figma-eds`
- `options.updateSectionModel` (default: true)
- `options.validateOutput` (default: true)
- `options.customVariables` (optional): Map of custom CSS variable overrides

**Returns:**
- Complete file set (CSS, JS, models, README, tests)
- Validation results and suggestions
- Section model integration status

## Universal Editor Model Pattern

**Critical Architecture Understanding**: The same block files (JS/CSS/JSON) serve BOTH Universal Editor authoring AND published site rendering:

### In Universal Editor (Authoring)
- Authors edit content through UI forms defined by the model JSON
- Model fields define what content is editable (headings, text, images, CTAs, etc.)
- Container models allow editing block-level content (main heading, description)
- Item models allow editing repeating content (card heading, card description, etc.)

### On Published Site (Rendering)
- JavaScript extracts content from DOM rows generated by Universal Editor
- Content-type detection identifies what each row contains (image, text, button)
- Same content authored in the model appears as rows in the DOM

### Model Generation Rules
1. **Container Model**: Include if block has container-level editable content (heading, intro text, etc.)
   - Example: `super-cards` has container heading field
   - Provides better authoring UX by making fields explicit
2. **Item Model**: Always include for multi-item blocks
   - Defines fields for each repeating item (card, slide, etc.)
3. **No Model Duplication**: Content should be in model OR extracted from rows, not both

## Generated Files

For each block the server generates the standard 3 core files (icon/extra docs generation removed to align with current project rules limiting blocks to CSS/JS/JSON). A provenance header comment containing the hash may be injected at the top of each file:

```
/blocks/[block-name]/
├── [block-name].css        # Design system compliant styling
├── [block-name].js         # Universal Editor decoration logic with content extraction
└── _[block-name].json      # Universal Editor model (container + item defs if multi-item)
```

### Model Structure for Multi-Item Blocks
```json
{
  "definitions": [
    {"id": "block-name", "...": "container definition"},
    {"id": "block-name-item", "...": "item definition"}
  ],
  "models": [
    {"id": "block-name", "fields": ["heading", "..."]},      // Container fields (if any)
    {"id": "block-name-item", "fields": ["icon", "heading", "..."]}  // Item fields
  ],
  "filters": [
    {"id": "block-name", "components": ["block-name-item"]}
  ]
}
```

## Architecture

### Core Components

- **DesignAnalyzer**: Derives structure and tokens from provided code signals
- **Generators**: Produce CSS, JS, model JSON
- **Validators**: Field naming & design system compliance
- **FileManager**: File system operations and section model integration
- **(Deprecated) FigmaClient**: Removed; stub retained only for backward compatibility

### Validation & Quality

- **Field Naming**: Enforces safe, Universal Editor compatible field names
- **Design System**: Validates CSS variable usage and prevents hardcoded values
- **Accessibility**: Ensures WCAG 2.1 AA compliance patterns
- **Performance**: Optimizes for bundle size and load times

## Installation

1. Build the server:
    ```bash
    npm install
    npm run build
    ```

2. Configure in your VS Code MCP settings (example `.vscode/mcp.json`):
    ```json
    {
       "servers": {
          "aem-eds-mcp": {
             "command": "node",
             "args": ["/absolute/path/to/figma-eds-mcp-server/dist/server.js"]
          }
       }
    }
    ```

3. **VS Code will automatically start and manage the MCP server** when you invoke its tools.

### Upgrading From ID-Based Version
If you previously passed `figmaFileKey` and `figmaNodeId`, remove them entirely. Calls now look like:
```jsonc
{
   "blockName": "feature-lists",
   "outputPath": "./blocks",
   "generatedCode": "<React/Tailwind snapshot>"
}
```

> Note: Environment variables for Figma tokens are no longer required; the server never calls Figma.

## Quality Standards

Generated blocks meet these standards:
- **Visual Accuracy**: Within 2% of Figma design
- **Accessibility**: WCAG 2.1 AA compliance (Lighthouse 100)
- **Performance**: Lighthouse ≥90 for all metrics
- **Code Quality**: Zero ESLint and Stylelint errors
- **Bundle Size**: CSS ≤5KB, JavaScript ≤3KB (minified+gzipped)

## Usage in VS Code Chat

Once configured, the MCP tools are available directly in GitHub Copilot Chat:

1. **Analyze a design context (already extracted):**
   ```
   @GitHub Copilot analyze this design context (paste code) with aem-eds-mcp/analyzeBlockStructure
   ```

2. **Generate a complete block:**
   ```
   @GitHub Copilot generate an EDS block called "feature-carousel" from this code (paste code) output to /blocks using generateEdsBlock (only generatedCode)
   ```

3. **Validate generated block:**
   ```
   @GitHub Copilot validate the feature-carousel block at /blocks/feature-carousel
   ```

The AI will use the appropriate MCP tools (`mcp_aem-eds-mcp_analyzeBlockStructure`, `mcp_aem-eds-mcp_generateEdsBlock`, etc.) automatically to complete your requests.

## Block Types Supported

### Single Item Blocks
- Hero sections
- Banner content
- Single card displays
- Simple content blocks

### Multi-Item Blocks
- Card collections
- Feature lists
- Gallery displays
- Repeatable content sections

## Integration

The server automatically:
- Adds new blocks to `/models/_section.json` allowedComponents
- Creates appropriate model definitions for Universal Editor
- Provides comprehensive documentation

## Development

- **Language**: TypeScript
- **Runtime**: Node.js 18+
- **Protocol**: Model Context Protocol (MCP)
- **External APIs**: None (artifact-only)
- **Target**: Adobe Edge Delivery Services + Universal Editor

## License

This project follows the same license as the parent Adobe Code Kit project.